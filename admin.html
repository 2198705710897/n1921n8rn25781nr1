<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Honed - License Key Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      padding: 20px;
      line-height: 1.6;
    }

    #loginOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0f172a;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .login-box {
      background: #1e293b;
      border-radius: 16px;
      padding: 40px;
      border: 1px solid #334155;
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    .login-box h2 {
      margin-bottom: 8px;
      color: #e2e8f0;
    }

    .login-box p {
      color: #64748b;
      margin-bottom: 24px;
    }

    .login-box input {
      width: 100%;
      padding: 14px 16px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .login-box input:focus {
      outline: none;
      border-color: #60a5fa;
    }

    .login-box button {
      width: 100%;
    }

    .login-error {
      color: #ef4444;
      font-size: 14px;
      margin-top: 12px;
      display: none;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 8px;
      background: linear-gradient(90deg, #60a5fa, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      color: #64748b;
      margin-bottom: 32px;
    }

    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid #334155;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: #1e293b;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #334155;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #60a5fa;
    }

    .stat-label {
      color: #64748b;
      font-size: 14px;
      margin-top: 4px;
    }

    .form-group {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #e2e8f0;
      font-size: 14px;
      font-family: 'Courier New', monospace;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #60a5fa;
    }

    input[type="text"]::placeholder {
      color: #475569;
    }

    button {
      padding: 12px 20px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #2563eb;
    }

    button.secondary {
      background: #475569;
    }

    button.secondary:hover {
      background: #64748b;
    }

    button.success {
      background: #10b981;
    }

    button.success:hover {
      background: #059669;
    }

    button.danger {
      background: #ef4444;
    }

    button.danger:hover {
      background: #dc2626;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #334155;
    }

    th {
      background: #0f172a;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #94a3b8;
    }

    tr:hover {
      background: #0f172a;
    }

    .key-badge {
      font-family: 'Courier New', monospace;
      background: #0f172a;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-active {
      background: #10b98120;
      color: #10b981;
    }

    .status-revoked {
      background: #ef444420;
      color: #ef4444;
    }

    .actions {
      display: flex;
      gap: 8px;
    }

    .actions button {
      padding: 6px 12px;
      font-size: 12px;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #64748b;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 16px 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid #10b981;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    .device-info {
      font-size: 12px;
      color: #64748b;
      font-family: 'Courier New', monospace;
    }

    .notes {
      color: #94a3b8;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Login Overlay -->
  <div id="loginOverlay">
    <div class="login-box">
      <h2>Admin Login</h2>
      <p>Enter your password to access the admin panel</p>
      <input type="password" id="adminPassword" placeholder="Enter password..." onkeypress="if(event.key==='Enter') attemptLogin()">
      <button onclick="attemptLogin()">Login</button>
      <div class="login-error" id="loginError">Incorrect password</div>
    </div>
  </div>

  <div class="container">
    <h1>Honed License Admin</h1>
    <p class="subtitle">Manage your license keys and device bindings</p>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="totalKeys">0</div>
        <div class="stat-label">Total Keys</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="activeKeys">0</div>
        <div class="stat-label">Active Keys</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="revokedKeys">0</div>
        <div class="stat-label">Revoked Keys</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="boundDevices">0</div>
        <div class="stat-label">Bound Devices</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Add License Key</h2>
        <button class="secondary" onclick="generateKey()">Generate Random Key</button>
      </div>
      <div class="form-group">
        <input type="text" id="newKeyInput" placeholder="XXXX-XXXX-XXXX-XXXX">
        <input type="text" id="newKeyNotes" placeholder="Customer name or notes (optional)">
        <button onclick="addKey()">Add Key</button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">License Keys</h2>
        <button class="secondary" onclick="loadKeys()">Refresh</button>
      </div>
      <div id="keysTable">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Device Bindings</h2>
        <button class="secondary" onclick="loadBindings()">Refresh</button>
      </div>
      <div id="bindingsTable">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    const ADMIN_PASSWORD_HASH = '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918'; // SHA-256 hash of "admin"

    const SUPABASE_URL = 'https://otmflwmqqjiatzvtsoys.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90bWZsd21xcWppYXR6dnRzb3lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxODY5NTUsImV4cCI6MjA4NDc2Mjk1NX0.Dy6pc_K64_riHTVxUuCLwzH5tE73Ze-nONyfdCp00_c';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function attemptLogin() {
      const password = document.getElementById('adminPassword').value;
      const errorDiv = document.getElementById('loginError');
      const hash = await sha256(password);

      if (hash === ADMIN_PASSWORD_HASH) {
        localStorage.setItem('adminAuth', Date.now().toString());
        document.getElementById('loginOverlay').style.display = 'none';
        loadKeys();
        loadBindings();
        loadStats();
      } else {
        errorDiv.style.display = 'block';
        document.getElementById('adminPassword').value = '';
      }
    }

    function checkAuth() {
      const auth = localStorage.getItem('adminAuth');
      if (!auth) return false;

      const authTime = parseInt(auth);
      const now = Date.now();
      const hoursSinceAuth = (now - authTime) / (1000 * 60 * 60);

      if (hoursSinceAuth > 24) {
        localStorage.removeItem('adminAuth');
        return false;
      }

      return true;
    }

    if (!checkAuth()) {
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('loginOverlay').style.display = 'flex';
      });
    } else {
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('loginOverlay').style.display = 'none';
        loadKeys();
        loadBindings();
        loadStats();
      });
    }

    async function loadStats() {
      const { data: keys } = await supabase.from('license_keys').select('*');
      const { data: bindings } = await supabase.from('device_bindings').select('*');

      document.getElementById('totalKeys').textContent = keys?.length || 0;
      document.getElementById('activeKeys').textContent = keys?.filter(k => !k.revoked).length || 0;
      document.getElementById('revokedKeys').textContent = keys?.filter(k => k.revoked).length || 0;
      document.getElementById('boundDevices').textContent = bindings?.length || 0;
    }

    async function loadKeys() {
      const table = document.getElementById('keysTable');
      table.innerHTML = '<div class="loading">Loading...</div>';

      const { data: keys, error } = await supabase
        .from('license_keys')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        table.innerHTML = `<div class="empty-state">Error: ${error.message}</div>`;
        return;
      }

      if (!keys || keys.length === 0) {
        table.innerHTML = '<div class="empty-state">No license keys found</div>';
        return;
      }

      table.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Key</th>
              <th>Status</th>
              <th>Notes</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${keys.map(key => `
              <tr>
                <td><span class="key-badge">${escapeHtml(key.key)}</span></td>
                <td>
                  <span class="status-badge ${key.revoked ? 'status-revoked' : 'status-active'}">
                    ${key.revoked ? 'Revoked' : 'Active'}
                  </span>
                </td>
                <td class="notes">${escapeHtml(key.notes || '-')}</td>
                <td style="color: #64748b; font-size: 13px;">${formatDate(key.created_at)}</td>
                <td>
                  <div class="actions">
                    ${key.revoked
                      ? `<button class="success" onclick="unrevokeKey('${key.key}')">Un-Revoke</button>`
                      : `<button class="danger" onclick="revokeKey('${key.key}')">Revoke</button>`
                    }
                    <button class="secondary" onclick="deleteKey('${key.key}')">Delete</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      loadStats();
    }

    async function loadBindings() {
      const table = document.getElementById('bindingsTable');
      table.innerHTML = '<div class="loading">Loading...</div>';

      const { data: bindings, error } = await supabase
        .from('device_bindings')
        .select('*')
        .order('bound_at', { ascending: false });

      if (error) {
        table.innerHTML = `<div class="empty-state">Error: ${error.message}</div>`;
        return;
      }

      if (!bindings || bindings.length === 0) {
        table.innerHTML = '<div class="empty-state">No device bindings found</div>';
        return;
      }

      table.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>License Key</th>
              <th>Device ID</th>
              <th>Bound At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${bindings.map(binding => `
              <tr>
                <td><span class="key-badge">${escapeHtml(binding.license_key.substring(0, 20))}...</span></td>
                <td><span class="device-info">${escapeHtml(binding.device_id)}</span></td>
                <td style="color: #64748b; font-size: 13px;">${formatDate(binding.bound_at)}</td>
                <td>
                  <div class="actions">
                    <button class="secondary" onclick="unbindDevice('${binding.license_key}')">Unbind</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function addKey() {
      const keyInput = document.getElementById('newKeyInput');
      const notesInput = document.getElementById('newKeyNotes');
      const key = keyInput.value.trim().toUpperCase();
      const notes = notesInput.value.trim();

      if (!key) {
        showToast('Please enter a license key', 'error');
        return;
      }

      const { error } = await supabase
        .from('license_keys')
        .insert({ key, notes });

      if (error) {
        showToast(`Error: ${error.message}`, 'error');
        return;
      }

      showToast('License key added successfully', 'success');
      keyInput.value = '';
      notesInput.value = '';
      loadKeys();
    }

    async function revokeKey(key) {
      if (!confirm(`Revoke key "${key}"?`)) return;

      const { error } = await supabase
        .from('license_keys')
        .update({ revoked: true })
        .eq('key', key);

      if (error) {
        showToast(`Error: ${error.message}`, 'error');
        return;
      }

      showToast('License key revoked', 'success');
      loadKeys();
    }

    async function unrevokeKey(key) {
      const { error } = await supabase
        .from('license_keys')
        .update({ revoked: false })
        .eq('key', key);

      if (error) {
        showToast(`Error: ${error.message}`, 'error');
        return;
      }

      showToast('License key un-revoked', 'success');
      loadKeys();
    }

    async function deleteKey(key) {
      if (!confirm(`Delete key "${key}"? This cannot be undone.`)) return;

      const { error } = await supabase
        .from('license_keys')
        .delete()
        .eq('key', key);

      if (error) {
        showToast(`Error: ${error.message}`, 'error');
        return;
      }

      showToast('License key deleted', 'success');
      loadKeys();
    }

    async function unbindDevice(licenseKey) {
      if (!confirm('Unbind this device? The license key will be available to bind to a new device.')) return;

      const { error } = await supabase
        .from('device_bindings')
        .delete()
        .eq('license_key', licenseKey);

      if (error) {
        showToast(`Error: ${error.message}`, 'error');
        return;
      }

      showToast('Device unbound successfully', 'success');
      loadBindings();
    }

    function generateKey() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ0123456789';
      const parts = [];
      for (let i = 0; i < 4; i++) {
        let part = '';
        for (let j = 0; j < 4; j++) {
          part += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        parts.push(part);
      }
      document.getElementById('newKeyInput').value = parts.join('-');
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleString();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
